"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[274],{1644(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"wrappers/api-route","title":"API Routes Wrapper","description":"Overview","source":"@site/docs/wrappers/api-route.md","sourceDirName":"wrappers","slug":"/wrappers/api-route","permalink":"/nextjs-fortress/docs/wrappers/api-route","draft":false,"unlisted":false,"editUrl":"https://github.com/mindfiredigital/nextjs-fortress/tree/main/docs/docs/wrappers/api-route.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Rate Limiting Protection","permalink":"/nextjs-fortress/docs/modules/rate-limit/rate-limiting"},"next":{"title":"Server Actions Wrapper","permalink":"/nextjs-fortress/docs/wrappers/server-action"}}');var r=t(7900),i=t(6493);const o={},a="API Routes Wrapper",l={},d=[{value:"Overview",id:"overview",level:2},{value:"Why Use the Wrapper",id:"why-use-the-wrapper",level:2},{value:"Implementation",id:"implementation",level:2},{value:"Basic Usage",id:"basic-usage",level:2},{value:"Setup",id:"setup",level:3},{value:"Simple Protection",id:"simple-protection",level:3},{value:"Advanced Configuration",id:"advanced-configuration",level:2},{value:"Custom Rate Limit",id:"custom-rate-limit",level:3},{value:"Method Restrictions",id:"method-restrictions",level:3},{value:"Custom Payload Size",id:"custom-payload-size",level:3},{value:"CSRF Protection",id:"csrf-protection",level:3},{value:"Disable Encoding Validation",id:"disable-encoding-validation",level:3},{value:"Combined Options",id:"combined-options",level:3},{value:"Options Reference",id:"options-reference",level:2},{value:"Real-World Examples",id:"real-world-examples",level:2},{value:"E-Commerce Checkout",id:"e-commerce-checkout",level:3},{value:"User Registration",id:"user-registration",level:3},{value:"Admin API",id:"admin-api",level:3},{value:"Error Responses",id:"error-responses",level:2},{value:"Method Not Allowed",id:"method-not-allowed",level:3},{value:"Rate Limit Exceeded",id:"rate-limit-exceeded",level:3},{value:"Payload Too Large",id:"payload-too-large",level:3},{value:"Invalid Encoding",id:"invalid-encoding",level:3},{value:"Validation Failed",id:"validation-failed",level:3},{value:"CSRF Invalid",id:"csrf-invalid",level:3},{value:"Summary",id:"summary",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"api-routes-wrapper",children:"API Routes Wrapper"})}),"\n",(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsxs)(n.p,{children:["The API Routes wrapper (",(0,r.jsx)(n.code,{children:"withFortress"}),") provides route-level security validation for Next.js API Routes with custom configuration per endpoint."]}),"\n",(0,r.jsx)(n.h2,{id:"why-use-the-wrapper",children:"Why Use the Wrapper"}),"\n",(0,r.jsx)(n.p,{children:"While middleware protects all routes globally, the wrapper allows:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Custom rate limits"})," per endpoint"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"CSRF validation"})," for specific routes"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Custom payload limits"})," per endpoint"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Method restrictions"})," per route"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Encoding validation toggle"})," per endpoint"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"implementation",children:"Implementation"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"/**\n * Create a secure API route wrapper\n */\nexport function createWithFortress(config: FortressConfig) {\n  const logger = new FortressLogger(config.logging);\n  const deserializationValidator = createDeserializationValidator(\n    config.modules.deserialization\n  );\n  const injectionValidator = createInjectionValidator(config.modules.injection);\n  const csrfValidator = config.modules.csrf.enabled\n    ? createCSRFValidator(config.modules.csrf)\n    : null;\n  const encodingValidator = createEncodingValidator(config.modules.encoding);\n\n  return function withFortress(\n    handler: (request: NextRequest) => Promise<Response>,\n    options: SecureRouteOptions = {}\n  ) {\n    return async function securedHandler(\n      request: NextRequest\n    ): Promise<Response> {\n      // 1. Check allowed methods\n      if (options.allowedMethods) {\n        if (!options.allowedMethods.includes(request.method)) {\n          return new NextResponse('Method Not Allowed', { status: 405 });\n        }\n      }\n\n      // 2. Rate limiting (if specified)\n      if (options.rateLimit) {\n        const rateLimitResult = checkRateLimit(request, options.rateLimit);\n        if (!rateLimitResult.allowed) {\n          return new NextResponse('Too Many Requests', {\n            status: 429,\n            headers: {\n              'Retry-After': String(\n                Math.ceil(rateLimitResult.retryAfter / 1000)\n              ),\n            },\n          });\n        }\n      }\n\n      // 3. Payload size check\n      const contentLength = request.headers.get('content-length');\n      const maxSize =\n        options.maxPayloadSize || config.modules.content.maxPayloadSize;\n\n      if (contentLength && parseInt(contentLength) > maxSize) {\n        return new NextResponse('Payload Too Large', { status: 413 });\n      }\n\n      // 4. Encoding validation\n      if (\n        options.validateEncoding !== false &&\n        config.modules.encoding.enabled\n      ) {\n        const contentType = request.headers.get('content-type');\n        const body = await request.clone().arrayBuffer();\n\n        const encodingResult = await encodingValidator.validate(\n          contentType,\n          body\n        );\n        if (!encodingResult.valid) {\n          return new NextResponse('Bad Request: Invalid Encoding', {\n            status: 400,\n          });\n        }\n      }\n\n      // 5. Parse and validate request body\n      if (['POST', 'PUT', 'PATCH'].includes(request.method)) {\n        const validationResult = await validateRequestBody(\n          request,\n          deserializationValidator,\n          injectionValidator,\n          config\n        );\n\n        if (!validationResult.valid) {\n          return new NextResponse('Forbidden', { status: 403 });\n        }\n      }\n\n      // 6. CSRF validation (if required)\n      if (options.requireCSRF && csrfValidator) {\n        const csrfToken =\n          request.headers.get(csrfValidator.getHeaderName()) ||\n          request.cookies.get(csrfValidator.getCookieName())?.value;\n\n        const sessionId = request.cookies.get('session')?.value || 'default';\n\n        const csrfResult = await csrfValidator.validate(\n          csrfToken,\n          sessionId,\n          request.method\n        );\n        if (!csrfResult.valid) {\n          return new NextResponse('Forbidden: Invalid CSRF Token', {\n            status: 403,\n          });\n        }\n      }\n\n      // Execute the original handler\n      return await handler(request);\n    };\n  };\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"basic-usage",children:"Basic Usage"}),"\n",(0,r.jsx)(n.h3,{id:"setup",children:"Setup"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// fortress.config.ts\nimport { FortressConfig } from '@mindfiredigital/nextjs-fortress';\n\nexport const fortressConfig: FortressConfig = {\n  enabled: true,\n  mode: 'development',\n  // ... your config\n};\n\n// lib/fortress.ts\nimport { createWithFortress } from '@mindfiredigital/nextjs-fortress';\nimport { fortressConfig } from '../fortress.config';\n\nexport const withFortress = createWithFortress(fortressConfig);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"simple-protection",children:"Simple Protection"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// app/api/user/route.ts\nimport { withFortress } from '@/lib/fortress';\n\nexport const POST = withFortress(async (request) => {\n  const data = await request.json();\n  \n  // Data already validated:\n  // \u2713 No prototype pollution\n  // \u2713 No SQL injection\n  // \u2713 No XSS\n  // \u2713 Valid encoding\n  \n  await updateUser(data);\n  return Response.json({ success: true });\n});\n"})}),"\n",(0,r.jsx)(n.h2,{id:"advanced-configuration",children:"Advanced Configuration"}),"\n",(0,r.jsx)(n.h3,{id:"custom-rate-limit",children:"Custom Rate Limit"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// app/api/auth/login/route.ts\nimport { withFortress } from '@/lib/fortress';\n\nexport const POST = withFortress(\n  async (request) => {\n    const { username, password } = await request.json();\n    const user = await authenticateUser(username, password);\n    return Response.json({ success: true, user });\n  },\n  {\n    rateLimit: {\n      requests: 5,       // Only 5 attempts\n      window: 300000,    // Per 5 minutes\n    },\n  }\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"method-restrictions",children:"Method Restrictions"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// app/api/data/route.ts\nimport { withFortress } from '@/lib/fortress';\n\nexport const handler = withFortress(\n  async (request) => {\n    if (request.method === 'GET') {\n      return Response.json(await getData());\n    }\n    \n    if (request.method === 'POST') {\n      const data = await request.json();\n      return Response.json(await createData(data));\n    }\n  },\n  {\n    allowedMethods: ['GET', 'POST'], // Only these methods\n  }\n);\n\nexport { handler as GET, handler as POST };\n"})}),"\n",(0,r.jsx)(n.h3,{id:"custom-payload-size",children:"Custom Payload Size"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// app/api/upload/route.ts\nimport { withFortress } from '@/lib/fortress';\n\nexport const POST = withFortress(\n  async (request) => {\n    const formData = await request.formData();\n    const file = formData.get('file');\n    return Response.json({ success: true });\n  },\n  {\n    maxPayloadSize: 10 * 1024 * 1024, // 10MB for file uploads\n  }\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"csrf-protection",children:"CSRF Protection"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// app/api/account/delete/route.ts\nimport { withFortress } from '@/lib/fortress';\n\nexport const POST = withFortress(\n  async (request) => {\n    const { userId } = await request.json();\n    await deleteAccount(userId);\n    return Response.json({ success: true });\n  },\n  {\n    requireCSRF: true, // Require valid CSRF token\n  }\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"disable-encoding-validation",children:"Disable Encoding Validation"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// app/api/webhook/route.ts\nimport { withFortress } from '@/lib/fortress';\n\nexport const POST = withFortress(\n  async (request) => {\n    // Handle webhook from third-party\n    const data = await request.text();\n    return Response.json({ received: true });\n  },\n  {\n    validateEncoding: false, // Skip encoding check for webhooks\n  }\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"combined-options",children:"Combined Options"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// app/api/admin/users/route.ts\nimport { withFortress } from '@/lib/fortress';\n\nexport const POST = withFortress(\n  async (request) => {\n    const data = await request.json();\n    await createUser(data);\n    return Response.json({ success: true });\n  },\n  {\n    requireCSRF: true,\n    allowedMethods: ['POST'],\n    rateLimit: {\n      requests: 10,\n      window: 60000,\n    },\n    maxPayloadSize: 50 * 1024, // 50KB\n  }\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"options-reference",children:"Options Reference"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"interface SecureRouteOptions {\n  // Require CSRF token validation\n  requireCSRF?: boolean;\n  \n  // Custom rate limit for this endpoint\n  rateLimit?: {\n    requests: number;\n    window: number; // milliseconds\n  };\n  \n  // Maximum payload size\n  maxPayloadSize?: number;\n  \n  // Allowed HTTP methods\n  allowedMethods?: string[];\n  \n  // Enable/disable encoding validation\n  validateEncoding?: boolean;\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"real-world-examples",children:"Real-World Examples"}),"\n",(0,r.jsx)(n.h3,{id:"e-commerce-checkout",children:"E-Commerce Checkout"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// app/api/checkout/route.ts\nimport { withFortress } from '@/lib/fortress';\n\nexport const POST = withFortress(\n  async (request) => {\n    const order = await request.json();\n    \n    // Validated data - safe to process\n    const result = await processPayment(order);\n    \n    return Response.json(result);\n  },\n  {\n    requireCSRF: true,           // Prevent CSRF\n    maxPayloadSize: 100 * 1024,  // 100KB max\n    rateLimit: {\n      requests: 3,               // 3 checkouts\n      window: 60000,             // per minute\n    },\n  }\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"user-registration",children:"User Registration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// app/api/auth/register/route.ts\nimport { withFortress } from '@/lib/fortress';\n\nexport const POST = withFortress(\n  async (request) => {\n    const userData = await request.json();\n    \n    // Already validated:\n    // - No prototype pollution\n    // - No SQL injection in fields\n    // - No XSS in inputs\n    \n    const user = await createUser(userData);\n    return Response.json({ success: true, user });\n  },\n  {\n    rateLimit: {\n      requests: 5,      // 5 registrations\n      window: 3600000,  // per hour\n    },\n    maxPayloadSize: 10 * 1024, // Small registration data\n  }\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"admin-api",children:"Admin API"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// app/api/admin/settings/route.ts\nimport { withFortress } from '@/lib/fortress';\n\nexport const POST = withFortress(\n  async (request) => {\n    const settings = await request.json();\n    await updateSettings(settings);\n    return Response.json({ success: true });\n  },\n  {\n    requireCSRF: true,           // Critical - require CSRF\n    allowedMethods: ['POST'],    // Only POST\n    rateLimit: {\n      requests: 20,\n      window: 60000,\n    },\n  }\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"error-responses",children:"Error Responses"}),"\n",(0,r.jsx)(n.h3,{id:"method-not-allowed",children:"Method Not Allowed"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Request: DELETE /api/user\n// Response:\nStatus: 405 Method Not Allowed\n"})}),"\n",(0,r.jsx)(n.h3,{id:"rate-limit-exceeded",children:"Rate Limit Exceeded"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Response:\nStatus: 429 Too Many Requests\nRetry-After: 45\n\n// Headers indicate when to retry\n"})}),"\n",(0,r.jsx)(n.h3,{id:"payload-too-large",children:"Payload Too Large"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Response:\nStatus: 413 Payload Too Large\n"})}),"\n",(0,r.jsx)(n.h3,{id:"invalid-encoding",children:"Invalid Encoding"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'// Response:\nStatus: 400 Bad Request\nBody: "Bad Request: Invalid Encoding"\n'})}),"\n",(0,r.jsx)(n.h3,{id:"validation-failed",children:"Validation Failed"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Response:\nStatus: 403 Forbidden\n"})}),"\n",(0,r.jsx)(n.h3,{id:"csrf-invalid",children:"CSRF Invalid"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'// Response:\nStatus: 403 Forbidden\nBody: "Forbidden: Invalid CSRF Token"\n'})}),"\n",(0,r.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"withFortress wrapper provides:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Route-level protection"}),"\n",(0,r.jsx)(n.li,{children:"Custom rate limits"}),"\n",(0,r.jsx)(n.li,{children:"CSRF validation"}),"\n",(0,r.jsx)(n.li,{children:"Method restrictions"}),"\n",(0,r.jsx)(n.li,{children:"Payload size limits"}),"\n",(0,r.jsx)(n.li,{children:"Encoding validation"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"How to use:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export const POST = withFortress(\n  async (request) => {\n    // Your handler\n  },\n  {\n    requireCSRF: true,\n    rateLimit: { requests: 10, window: 60000 },\n  }\n);\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Related Documentation:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/nextjs-fortress/docs/wrappers/server-action",children:"Server Actions Wrapper"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/nextjs-fortress/docs/modules/rate-limit/rate-limiting",children:"Rate Limiting"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},6493(e,n,t){t.d(n,{R:()=>o,x:()=>a});var s=t(2128);const r={},i=s.createContext(r);function o(e){const n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);