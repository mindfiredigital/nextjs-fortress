"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[155],{4148(e,n,r){r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"modules/deserialization/circular-references","title":"Circular Reference Detection","description":"Overview","source":"@site/docs/modules/deserialization/circular-references.md","sourceDirName":"modules/deserialization","slug":"/modules/deserialization/circular-references","permalink":"/nextjs-fortress/docs/modules/deserialization/circular-references","draft":false,"unlisted":false,"editUrl":"https://github.com/mindfiredigital/nextjs-fortress/tree/main/docs/docs/modules/deserialization/circular-references.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Depth Limiting Protection","permalink":"/nextjs-fortress/docs/modules/deserialization/depth-limiting"},"next":{"title":"Dangerous Patterns Detection","permalink":"/nextjs-fortress/docs/modules/deserialization/dangerous-patterns"}}');var s=r(7900),t=r(6493);const a={},l="Circular Reference Detection",o={},c=[{value:"Overview",id:"overview",level:2},{value:"Why This Is Important",id:"why-this-is-important",level:2},{value:"The Problem: Self-Referencing Objects",id:"the-problem-self-referencing-objects",level:3},{value:"1. <strong>Infinite Loop Attack</strong>",id:"1-infinite-loop-attack",level:4},{value:"2. <strong>Memory Exhaustion</strong>",id:"2-memory-exhaustion",level:4},{value:"3. <strong>JSON Serialization DoS</strong>",id:"3-json-serialization-dos",level:4},{value:"4. <strong>Database Corruption</strong>",id:"4-database-corruption",level:4},{value:"How nextjs-fortress Solves This",id:"how-nextjs-fortress-solves-this",level:2},{value:"The Algorithm",id:"the-algorithm",level:3},{value:"Why This Works",id:"why-this-works",level:3},{value:"WeakSet Advantages",id:"weakset-advantages",level:3},{value:"How to Initialize",id:"how-to-initialize",level:2},{value:"Summary",id:"summary",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"circular-reference-detection",children:"Circular Reference Detection"})}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(n.p,{children:"Circular reference detection prevents attackers from sending self-referencing objects that can cause infinite loops, memory exhaustion, and application crashes."}),"\n",(0,s.jsx)(n.h2,{id:"why-this-is-important",children:"Why This Is Important"}),"\n",(0,s.jsx)(n.h3,{id:"the-problem-self-referencing-objects",children:"The Problem: Self-Referencing Objects"}),"\n",(0,s.jsx)(n.p,{children:"Attackers can craft payloads where objects reference themselves, creating circular dependencies:"}),"\n",(0,s.jsxs)(n.h4,{id:"1-infinite-loop-attack",children:["1. ",(0,s.jsx)(n.strong,{children:"Infinite Loop Attack"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'// Attacker creates circular reference\nconst malicious = { name: "user" };\nmalicious.self = malicious; // References itself\n\n// Without protection, this happens:\nJSON.stringify(malicious);\n// TypeError: Converting circular structure to JSON\n\n// Serialization libraries try to traverse:\nfunction serialize(obj) {\n  for (const key in obj) {\n    serialize(obj[key]); // Infinite recursion\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"What Happens Without Protection:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Serialization fails"}),"\n",(0,s.jsx)(n.li,{children:"Stack overflow errors"}),"\n",(0,s.jsx)(n.li,{children:"Application crashes"}),"\n",(0,s.jsx)(n.li,{children:"Server becomes unresponsive"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Impact:"})," Server crashes and immediate downtime Infinite loops consume CPU Stack overflow errors Denial of Service (DoS)"]}),"\n",(0,s.jsxs)(n.h4,{id:"2-memory-exhaustion",children:["2. ",(0,s.jsx)(n.strong,{children:"Memory Exhaustion"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"// Circular reference with deep nesting\nconst attack = { level1: {} };\nattack.level1.level2 = { level3: attack };\n\n// Validator tries to traverse:\nfunction validate(obj, seen = []) {\n  seen.push(obj);\n  for (const value of Object.values(obj)) {\n    if (!seen.includes(value)) {\n      validate(value, seen); // Keeps growing 'seen' array\n    }\n  }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"What Happens Without Protection:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Validation code traverses repeatedly"}),"\n",(0,s.jsx)(n.li,{children:"Memory usage grows exponentially"}),"\n",(0,s.jsx)(n.li,{children:"Garbage collector struggles"}),"\n",(0,s.jsx)(n.li,{children:"Server runs out of memory"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Impact:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Memory exhaustion and OOM errors"}),"\n",(0,s.jsx)(n.li,{children:"Performance degradation"}),"\n",(0,s.jsx)(n.li,{children:"CPU spikes during GC"}),"\n",(0,s.jsx)(n.li,{children:"Affects all users"}),"\n"]}),"\n",(0,s.jsxs)(n.h4,{id:"3-json-serialization-dos",children:["3. ",(0,s.jsx)(n.strong,{children:"JSON Serialization DoS"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"// Many APIs serialize responses\napp.post('/api/user', async (req, res) => {\n  const userData = await req.json(); // Contains circular ref\n  \n  // Later in the code:\n  await db.save(JSON.stringify(userData)); // Crash\n  \n  // Or\n  return res.json(userData); // Crash\n});\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"What Happens Without Protection:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"JSON.stringify() throws error"}),"\n",(0,s.jsx)(n.li,{children:"API endpoint crashes"}),"\n",(0,s.jsx)(n.li,{children:"Error propagates"}),"\n",(0,s.jsx)(n.li,{children:"Service becomes unavailable"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Impact:"})," API endpoint crashes Service unavailability Error cascades Lost revenue"]}),"\n",(0,s.jsxs)(n.h4,{id:"4-database-corruption",children:["4. ",(0,s.jsx)(n.strong,{children:"Database Corruption"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'// Circular data sent to database\nconst user = {\n  name: "attacker",\n  profile: {}\n};\nuser.profile.owner = user; // Circular\n\n// Without protection:\nawait db.users.insert(user); // Database tries to serialize\n// Error: cannot insert circular structure\n// But connection may be left in bad state\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"What Happens Without Protection:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Database driver fails"}),"\n",(0,s.jsx)(n.li,{children:"Connection corruption"}),"\n",(0,s.jsx)(n.li,{children:"Transaction rollback"}),"\n",(0,s.jsx)(n.li,{children:"Data inconsistency"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Impact:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Database connection issues"}),"\n",(0,s.jsx)(n.li,{children:"Transaction failures"}),"\n",(0,s.jsx)(n.li,{children:"Data inconsistency"}),"\n",(0,s.jsx)(n.li,{children:"Application instability"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"how-nextjs-fortress-solves-this",children:"How nextjs-fortress Solves This"}),"\n",(0,s.jsx)(n.h3,{id:"the-algorithm",children:"The Algorithm"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"/**\n * Check for circular references using WeakSet\n */\nprivate checkCircularReferences(\n  obj: unknown,\n  seen = new WeakSet()\n): ValidationResult {\n  if (obj === null || typeof obj !== 'object') {\n    return { valid: true };\n  }\n\n  // Check if we've seen this object before\n  if (seen.has(obj)) {\n    return {\n      valid: false,\n      severity: 'high',\n      message: 'Circular reference detected in payload',\n      rule: 'circular_reference',\n      confidence: 1.0,\n    };\n  }\n\n  // Mark this object as seen\n  seen.add(obj);\n\n  // Recursively check all nested values\n  for (const value of Object.values(obj)) {\n    if (value !== null && typeof value === 'object') {\n      const result = this.checkCircularReferences(value, seen);\n      if (!result.valid) {\n        return result;\n      }\n    }\n  }\n\n  return { valid: true };\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"why-this-works",children:"Why This Works"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"1. WeakSet Tracking"})," - Efficiently tracks seen objects without preventing garbage collection\n",(0,s.jsx)(n.strong,{children:"2. Early Detection"})," - Stops immediately when circular reference found\n",(0,s.jsx)(n.strong,{children:"3. Memory Safe"})," - WeakSet doesn't prevent GC of tracked objects\n",(0,s.jsx)(n.strong,{children:"4. Fast Performance"})," - O(n) time complexity"]}),"\n",(0,s.jsx)(n.h3,{id:"weakset-advantages",children:"WeakSet Advantages"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Traditional approach (BAD)\nconst seen = []; // Array grows indefinitely\nseen.includes(obj); // O(n) lookup\n\n// Fortress approach (GOOD)\nconst seen = new WeakSet(); // Doesn't prevent GC\nseen.has(obj); // O(1) lookup\n"})}),"\n",(0,s.jsx)(n.h2,{id:"how-to-initialize",children:"How to Initialize"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import { FortressConfig } from '@mindfiredigital/nextjs-fortress';\n\nexport const fortressConfig: FortressConfig = {\n  enabled: true,\n  mode: 'development',\n\n  modules: {\n    deserialization: {\n      enabled: true,\n      maxDepth: 10,\n      detectCircular: true,      // Enable this!\n      \n      blockList: [\n        '__proto__',\n        'constructor',\n        'prototype',\n      ],\n    },\n  },\n\n  onSecurityEvent: async (event) => {\n    if (event.detection.rule === 'circular_reference') {\n      console.warn('Circular reference attack blocked:', {\n        ip: event.request.ip,\n        path: event.request.path,\n      });\n    }\n  },\n};\n"})}),"\n",(0,s.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"What happens without circular reference detection:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Infinite loops crash server"}),"\n",(0,s.jsx)(n.li,{children:"Memory exhaustion"}),"\n",(0,s.jsx)(n.li,{children:"JSON serialization failures"}),"\n",(0,s.jsx)(n.li,{children:"Database corruption"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"What nextjs-fortress provides:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"WeakSet-based detection"}),"\n",(0,s.jsx)(n.li,{children:"Early attack prevention"}),"\n",(0,s.jsx)(n.li,{children:"Memory-safe implementation"}),"\n",(0,s.jsx)(n.li,{children:"Zero performance impact"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"How to initialize:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"deserialization: {\n  enabled: true,\n  detectCircular: true,  // Enable circular detection\n  maxDepth: 10,\n}\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Related Documentation:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/nextjs-fortress/docs/modules/deserialization/dangerous-keys",children:"Dangerous Keys Detection"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/nextjs-fortress/docs/modules/deserialization/depth-limiting",children:"Depth Limiting"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/nextjs-fortress/docs/modules/deserialization/dangerous-patterns",children:"Dangerous Patterns"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},6493(e,n,r){r.d(n,{R:()=>a,x:()=>l});var i=r(2128);const s={},t=i.createContext(s);function a(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);