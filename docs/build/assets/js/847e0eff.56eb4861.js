"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[878],{6105(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"modules/csrf/csrf-protection","title":"CSRF Protection (Cross-Site Request Forgery)","description":"Overview","source":"@site/docs/modules/csrf/csrf-protection.md","sourceDirName":"modules/csrf","slug":"/modules/csrf/csrf-protection","permalink":"/nextjs-fortress/docs/modules/csrf/csrf-protection","draft":false,"unlisted":false,"editUrl":"https://github.com/mindfiredigital/nextjs-fortress/tree/main/docs/docs/modules/csrf/csrf-protection.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Ghost Mode Protection (Encoding Bypass)","permalink":"/nextjs-fortress/docs/modules/encoding/ghost-mode"},"next":{"title":"Rate Limiting Protection","permalink":"/nextjs-fortress/docs/modules/rate-limit/rate-limiting"}}');var i=t(7900),r=t(6493);const o={},a="CSRF Protection (Cross-Site Request Forgery)",l={},c=[{value:"Overview",id:"overview",level:2},{value:"Why This Is Important",id:"why-this-is-important",level:2},{value:"The Problem: Cross-Site Request Forgery",id:"the-problem-cross-site-request-forgery",level:3},{value:"1. <strong>State-Changing Actions</strong>",id:"1-state-changing-actions",level:4},{value:"2. <strong>Form Auto-Submission</strong>",id:"2-form-auto-submission",level:4},{value:"3. <strong>JSON API Exploitation</strong>",id:"3-json-api-exploitation",level:4},{value:"4. <strong>Silent Background Requests</strong>",id:"4-silent-background-requests",level:4},{value:"How nextjs-fortress Solves This",id:"how-nextjs-fortress-solves-this",level:2},{value:"Token Generation",id:"token-generation",level:3},{value:"Token Validation",id:"token-validation",level:3},{value:"Attack Prevention Examples",id:"attack-prevention-examples",level:2},{value:"Example 1: Form Submission Attack",id:"example-1-form-submission-attack",level:3},{value:"Example 2: Invalid Token Attack",id:"example-2-invalid-token-attack",level:3},{value:"Example 3: Expired Token",id:"example-3-expired-token",level:3},{value:"How to Initialize",id:"how-to-initialize",level:2},{value:"Token Lifecycle",id:"token-lifecycle",level:2},{value:"Summary",id:"summary",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"csrf-protection-cross-site-request-forgery",children:"CSRF Protection (Cross-Site Request Forgery)"})}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(n.p,{children:"CSRF protection prevents attackers from tricking authenticated users into performing unwanted actions by validating that requests originate from your application."}),"\n",(0,i.jsx)(n.h2,{id:"why-this-is-important",children:"Why This Is Important"}),"\n",(0,i.jsx)(n.h3,{id:"the-problem-cross-site-request-forgery",children:"The Problem: Cross-Site Request Forgery"}),"\n",(0,i.jsx)(n.p,{children:"Attackers trick authenticated users' browsers into making malicious requests:"}),"\n",(0,i.jsxs)(n.h4,{id:"1-state-changing-actions",children:["1. ",(0,i.jsx)(n.strong,{children:"State-Changing Actions"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-html",children:"\x3c!-- Attacker's malicious website --\x3e\n<img src=\"https://yourbank.com/transfer?to=attacker&amount=10000\">\n\n\x3c!-- When logged-in user visits attacker's site: --\x3e\n\x3c!-- Browser automatically sends cookies with request --\x3e\n\x3c!-- Bank processes transfer without user knowledge --\x3e\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"What Happens Without Protection:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Browser sends authentication cookies"}),"\n",(0,i.jsx)(n.li,{children:"Server sees valid session"}),"\n",(0,i.jsx)(n.li,{children:"Action executed without consent"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Impact:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Unauthorized transfers"}),"\n",(0,i.jsx)(n.li,{children:"Data deletion"}),"\n",(0,i.jsx)(n.li,{children:"Settings changed"}),"\n",(0,i.jsx)(n.li,{children:"Account takeover"}),"\n"]}),"\n",(0,i.jsxs)(n.h4,{id:"2-form-auto-submission",children:["2. ",(0,i.jsx)(n.strong,{children:"Form Auto-Submission"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-html",children:'\x3c!-- Attacker\'s page --\x3e\n<form action="https://yoursite.com/api/user/delete" method="POST">\n  <input type="hidden" name="confirm" value="yes">\n</form>\n<script>\n  document.forms[0].submit();\n<\/script>\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"What Happens Without Protection:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Form auto-submits on page load"}),"\n",(0,i.jsx)(n.li,{children:"User's cookies sent automatically"}),"\n",(0,i.jsx)(n.li,{children:"Account deleted without consent"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Impact"}),": Account deleti Data lo Security settings chang Privacy violations"]}),"\n",(0,i.jsxs)(n.h4,{id:"3-json-api-exploitation",children:["3. ",(0,i.jsx)(n.strong,{children:"JSON API Exploitation"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// Attacker's website makes fetch request\nfetch('https://yoursite.com/api/admin/promote', {\n  method: 'POST',\n  credentials: 'include', // Sends cookies\n  headers: { 'Content-Type': 'application/json' },\n  body: JSON.stringify({ userId: 'attacker', role: 'admin' })\n});\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"What Happens Without Protection:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Credentials included automatically"}),"\n",(0,i.jsx)(n.li,{children:"Admin API called"}),"\n",(0,i.jsx)(n.li,{children:"Attacker promoted to admin"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Impact:"})," Privilege escalation Unauthorized access Admin rights granted Full compromise"]}),"\n",(0,i.jsxs)(n.h4,{id:"4-silent-background-requests",children:["4. ",(0,i.jsx)(n.strong,{children:"Silent Background Requests"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-html",children:'\x3c!-- Invisible iframe on attacker\'s site --\x3e\n<iframe style="display:none" \n  src="https://yoursite.com/api/settings?email=attacker@evil.com">\n</iframe>\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"What Happens Without Protection:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Request made in background"}),"\n",(0,i.jsx)(n.li,{children:"User doesn't notice"}),"\n",(0,i.jsx)(n.li,{children:"Email changed to attacker's"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Impact:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Email hijacking"}),"\n",(0,i.jsx)(n.li,{children:"Password reset to attacker"}),"\n",(0,i.jsx)(n.li,{children:"Account takeover"}),"\n",(0,i.jsx)(n.li,{children:"Complete compromise"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"how-nextjs-fortress-solves-this",children:"How nextjs-fortress Solves This"}),"\n",(0,i.jsx)(n.h3,{id:"token-generation",children:"Token Generation"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"/**\n * Generate a new CSRF token for a session\n */\npublic async generateToken(sessionId: string): Promise<string> {\n  const tokenLength = this.config.tokenLength || 32;\n  const expiryMs = this.config.expiryMs || 24 * 60 * 60 * 1000;\n\n  // Generate random token\n  const randomBuffer = await generateRandomBytes(tokenLength);\n  const randomToken = arrayBufferToHex(randomBuffer.buffer);\n\n  // Create HMAC signature\n  const signature = await this.createSignature(randomToken, sessionId);\n  const token = `${randomToken}.${signature}`;\n\n  // Store token with expiry\n  tokenStore.set(sessionId, {\n    token,\n    createdAt: Date.now(),\n    expiresAt: Date.now() + expiryMs,\n  });\n\n  return token;\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"token-validation",children:"Token Validation"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"/**\n * Validate CSRF token from request\n */\npublic async validate(\n  token: string | null | undefined,\n  sessionId: string,\n  method: string\n): Promise<ValidationResult> {\n  // Safe methods don't require CSRF protection\n  const safeMethods = ['GET', 'HEAD', 'OPTIONS'];\n  if (safeMethods.includes(method.toUpperCase())) {\n    return { valid: true };\n  }\n\n  // No token provided\n  if (!token) {\n    return {\n      valid: false,\n      severity: 'high',\n      message: 'CSRF token missing',\n      rule: 'csrf_token_missing',\n      confidence: 1.0,\n    };\n  }\n\n  // Get stored token\n  const storedToken = tokenStore.get(sessionId);\n  if (!storedToken) {\n    return {\n      valid: false,\n      severity: 'high',\n      message: 'No CSRF token found for session',\n      rule: 'csrf_no_session_token',\n      confidence: 1.0,\n    };\n  }\n\n  // Check expiry\n  if (Date.now() > storedToken.expiresAt) {\n    tokenStore.delete(sessionId);\n    return {\n      valid: false,\n      severity: 'medium',\n      message: 'CSRF token expired',\n      rule: 'csrf_token_expired',\n      confidence: 1.0,\n    };\n  }\n\n  // Validate token matches\n  if (token !== storedToken.token) {\n    return {\n      valid: false,\n      severity: 'critical',\n      message: 'Invalid CSRF token',\n      rule: 'csrf_token_invalid',\n      confidence: 1.0,\n    };\n  }\n\n  // Verify signature\n  const [randomPart, signature] = token.split('.');\n  const expectedSignature = await this.createSignature(randomPart, sessionId);\n\n  if (signature !== expectedSignature) {\n    return {\n      valid: false,\n      severity: 'critical',\n      message: 'CSRF token signature mismatch',\n      rule: 'csrf_signature_invalid',\n      confidence: 1.0,\n    };\n  }\n\n  return { valid: true };\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"attack-prevention-examples",children:"Attack Prevention Examples"}),"\n",(0,i.jsx)(n.h3,{id:"example-1-form-submission-attack",children:"Example 1: Form Submission Attack"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:'// Attacker tries to submit form\nPOST /api/user/delete\nCookie: session=user123\n// Missing CSRF token\n\n// Fortress response:\n{\n  "error": "CSRF token missing",\n  "rule": "csrf_token_missing"\n}\n// Status: 403 Forbidden\n// Result: BLOCKED \u2705\n'})}),"\n",(0,i.jsx)(n.h3,{id:"example-2-invalid-token-attack",children:"Example 2: Invalid Token Attack"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// Attacker uses fake token\nPOST /api/admin/promote\nCookie: session=user123\nX-CSRF-Token: fake-token-12345\n\n// Fortress validates:\n// 1. Token format check\n// 2. Signature verification\n// 3. Session matching\n// Result: BLOCKED \u2705\n"})}),"\n",(0,i.jsx)(n.h3,{id:"example-3-expired-token",children:"Example 3: Expired Token"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:'// Token expired after 24 hours\nPOST /api/settings\nCookie: session=user123\nX-CSRF-Token: old-token.signature\n\n// Fortress response:\n{\n  "error": "CSRF token expired",\n  "rule": "csrf_token_expired"\n}\n// Result: BLOCKED \u2705\n'})}),"\n",(0,i.jsx)(n.h2,{id:"how-to-initialize",children:"How to Initialize"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { FortressConfig, FortressLogger } from '@mindfiredigital/nextjs-fortress';\n\nexport const fortressConfig: FortressConfig = {\n  enabled: true,\n  mode: 'development',\n\n  modules: {\n    csrf: {\n      enabled: true,\n      cookieName: '_csrf',\n      headerName: 'X-CSRF-Token',\n      tokenSecret: process.env.CSRF_SECRET,\n      tokenLength: 32,\n      expiryMs: 24 * 60 * 60 * 1000, // 24 hours\n    },\n  },\n\n  onSecurityEvent: async (event) => {\n    if (event.type === 'csrf') {\n      const logger = new FortressLogger({\n        enabled: true,\n        level: 'warn',\n        destination: 'console',\n      });\n\n      logger.warn('\ud83d\udee1\ufe0f CSRF Attack Blocked', {\n        rule: event.detection.rule,\n        ip: event.request.ip,\n        path: event.request.path,\n      });\n    }\n  },\n};\n"})}),"\n",(0,i.jsx)(n.h2,{id:"token-lifecycle",children:"Token Lifecycle"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Generation"})," - Token created when user visits site"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Storage"})," - Token stored in cookie and server-side"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Validation"})," - Token checked on state-changing requests"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Expiry"})," - Token expires after configured time"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Cleanup"})," - Expired tokens removed automatically"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"What happens without CSRF protection:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Unauthorized actions"}),"\n",(0,i.jsx)(n.li,{children:"Account takeover"}),"\n",(0,i.jsx)(n.li,{children:"Data manipulation"}),"\n",(0,i.jsx)(n.li,{children:"Silent attacks"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"What nextjs-fortress provides:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Cryptographic tokens"}),"\n",(0,i.jsx)(n.li,{children:"Signature verification"}),"\n",(0,i.jsx)(n.li,{children:"Automatic validation"}),"\n",(0,i.jsx)(n.li,{children:"Expiry management"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"How to initialize:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"csrf: {\n  enabled: true,\n  cookieName: '_csrf',\n  tokenSecret: process.env.CSRF_SECRET,\n}\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Related Documentation:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/nextjs-fortress/docs/modules/rate-limit/rate-limiting",children:"Rate Limiting"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},6493(e,n,t){t.d(n,{R:()=>o,x:()=>a});var s=t(2128);const i={},r=s.createContext(i);function o(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);