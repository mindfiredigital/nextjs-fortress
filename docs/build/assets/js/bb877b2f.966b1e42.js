"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[587],{6493(e,n,t){t.d(n,{R:()=>a,x:()=>o});var r=t(2128);const i={},s=r.createContext(i);function a(e){const n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(s.Provider,{value:n},e.children)}},9751(e,n,t){t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"wrappers/server-action","title":"Server Actions Wrapper","description":"Overview","source":"@site/docs/wrappers/server-action.md","sourceDirName":"wrappers","slug":"/wrappers/server-action","permalink":"/nextjs-fortress/docs/wrappers/server-action","draft":false,"unlisted":false,"editUrl":"https://github.com/mindfiredigital/nextjs-fortress/tree/main/docs/docs/wrappers/server-action.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"API Routes Wrapper","permalink":"/nextjs-fortress/docs/wrappers/api-route"},"next":{"title":"CVE-2025-55182: React Server Components Deserialization Vulnerability","permalink":"/nextjs-fortress/docs/cve/cve-2025-55182"}}');var i=t(7900),s=t(6493);const a={},o="Server Actions Wrapper",c={},l=[{value:"Overview",id:"overview",level:2},{value:"Why Use the Wrapper",id:"why-use-the-wrapper",level:2},{value:"Implementation",id:"implementation",level:2},{value:"Basic Usage",id:"basic-usage",level:2},{value:"Setup",id:"setup",level:3},{value:"Simple Protection",id:"simple-protection",level:3},{value:"Advanced Configuration",id:"advanced-configuration",level:2},{value:"With Input Sanitization",id:"with-input-sanitization",level:3},{value:"With CSRF Protection",id:"with-csrf-protection",level:3},{value:"With Input Restrictions",id:"with-input-restrictions",level:3},{value:"With Depth Limiting",id:"with-depth-limiting",level:3},{value:"Options Reference",id:"options-reference",level:2},{value:"Real-World Examples",id:"real-world-examples",level:2},{value:"Form Submission",id:"form-submission",level:3},{value:"User Authentication",id:"user-authentication",level:3},{value:"Data Update",id:"data-update",level:3},{value:"File Upload Processing",id:"file-upload-processing",level:3},{value:"Admin Operations",id:"admin-operations",level:3},{value:"Input Sanitization",id:"input-sanitization",level:2},{value:"Nested Sanitization",id:"nested-sanitization",level:3},{value:"Error Handling",id:"error-handling",level:2},{value:"Validation Error",id:"validation-error",level:3},{value:"Injection Detected",id:"injection-detected",level:3},{value:"CSRF Validation Failed",id:"csrf-validation-failed",level:3},{value:"Client-Side Usage",id:"client-side-usage",level:2},{value:"With Form",id:"with-form",level:3},{value:"With State Management",id:"with-state-management",level:3},{value:"Summary",id:"summary",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"server-actions-wrapper",children:"Server Actions Wrapper"})}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsxs)(n.p,{children:["The Server Actions wrapper (",(0,i.jsx)(n.code,{children:"secureServerAction"}),") protects Next.js Server Actions from prototype pollution, injection attacks, and validates all input arguments automatically."]}),"\n",(0,i.jsx)(n.h2,{id:"why-use-the-wrapper",children:"Why Use the Wrapper"}),"\n",(0,i.jsx)(n.p,{children:"Server Actions are particularly vulnerable because:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Data comes directly from forms"}),"\n",(0,i.jsx)(n.li,{children:"No URL-based routing protection"}),"\n",(0,i.jsx)(n.li,{children:"Arguments passed directly to functions"}),"\n",(0,i.jsx)(n.li,{children:"Easy to forget validation"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"The wrapper provides:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Automatic argument validation"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Input sanitization"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"CSRF protection"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Prototype pollution prevention"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Injection detection"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"implementation",children:"Implementation"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"/**\n * Create a secure server action wrapper\n */\nexport function createSecureServerAction(config: FortressConfig) {\n  const logger = new FortressLogger(config.logging);\n  const deserializationValidator = createDeserializationValidator(\n    config.modules.deserialization\n  );\n  const injectionValidator = createInjectionValidator(config.modules.injection);\n  const csrfValidator = config.modules.csrf.enabled\n    ? createCSRFValidator(config.modules.csrf)\n    : null;\n\n  return function secureServerAction<TArgs extends unknown[], TReturn>(\n    action: (...args: TArgs) => Promise<TReturn>,\n    options: SecureActionOptions = {}\n  ) {\n    return async function securedAction(...args: TArgs): Promise<TReturn> {\n      // 1. Validate deserialization\n      if (config.modules.deserialization.enabled) {\n        for (const arg of args) {\n          const result = deserializationValidator.validate(arg);\n          if (!result.valid) {\n            logger.warn(`Server action blocked: ${result.message}`);\n            throw new SecurityError(\n              result.message || 'Invalid input detected',\n              result.rule || 'deserialization'\n            );\n          }\n        }\n      }\n\n      // 2. Validate injection\n      if (config.modules.injection.enabled) {\n        for (const arg of args) {\n          const result = injectionValidator.validate(arg);\n          if (!result.valid) {\n            logger.warn(\n              `Injection attempt in server action: ${result.message}`\n            );\n            throw new SecurityError(\n              result.message || 'Injection detected',\n              result.rule || 'injection'\n            );\n          }\n        }\n      }\n\n      // 3. CSRF validation (if required)\n      if (options.requireCSRF && csrfValidator) {\n        const csrfToken = extractCSRFToken(args);\n        const sessionId = extractSessionId(args);\n\n        const result = await csrfValidator.validate(\n          csrfToken,\n          sessionId,\n          'POST'\n        );\n        if (!result.valid) {\n          logger.warn(`CSRF validation failed: ${result.message}`);\n          throw new SecurityError(\n            result.message || 'CSRF validation failed',\n            result.rule || 'csrf'\n          );\n        }\n      }\n\n      // 4. Sanitize inputs if requested\n      let sanitizedArgs = args;\n      if (options.sanitizeInputs) {\n        sanitizedArgs = sanitizeInputs(args) as TArgs;\n      }\n\n      // Execute the original action with sanitized inputs\n      return await action(...sanitizedArgs);\n    };\n  };\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"basic-usage",children:"Basic Usage"}),"\n",(0,i.jsx)(n.h3,{id:"setup",children:"Setup"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// fortress.config.ts\nimport { FortressConfig } from '@mindfiredigital/nextjs-fortress';\n\nexport const fortressConfig: FortressConfig = {\n  enabled: true,\n  mode: 'development',\n  // ... your config\n};\n\n// lib/fortress.ts\nimport { createSecureServerAction } from '@mindfiredigital/nextjs-fortress';\nimport { fortressConfig } from '../fortress.config';\n\nexport const secureServerAction = createSecureServerAction(fortressConfig);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"simple-protection",children:"Simple Protection"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// app/actions.ts\n'use server';\n\nimport { secureServerAction } from '@/lib/fortress';\n\nexport const updateProfile = secureServerAction(\n  async (userId: string, profile: ProfileData) => {\n    // All arguments validated:\n    // \u2713 No prototype pollution\n    // \u2713 No SQL injection\n    // \u2713 No XSS\n    \n    await db.profiles.update(userId, profile);\n    return { success: true };\n  }\n);\n"})}),"\n",(0,i.jsx)(n.h2,{id:"advanced-configuration",children:"Advanced Configuration"}),"\n",(0,i.jsx)(n.h3,{id:"with-input-sanitization",children:"With Input Sanitization"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// app/actions.ts\n'use server';\n\nimport { secureServerAction } from '@/lib/fortress';\n\nexport const createPost = secureServerAction(\n  async (title: string, content: string) => {\n    // Inputs sanitized:\n    // - __proto__ removed\n    // - constructor removed\n    // - prototype removed\n    \n    const post = await db.posts.create({ title, content });\n    return { success: true, post };\n  },\n  {\n    sanitizeInputs: true, // Remove dangerous keys\n  }\n);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"with-csrf-protection",children:"With CSRF Protection"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// app/actions.ts\n'use server';\n\nimport { secureServerAction } from '@/lib/fortress';\n\nexport const deleteAccount = secureServerAction(\n  async (userId: string, metadata: ActionMetadata) => {\n    // CSRF token validated from metadata._csrf\n    await db.users.delete(userId);\n    return { success: true };\n  },\n  {\n    requireCSRF: true, // Validate CSRF token\n  }\n);\n\n// Client usage:\ninterface ActionMetadata {\n  _csrf: string;\n  sessionId: string;\n}\n\nawait deleteAccount(userId, {\n  _csrf: getCsrfToken(),\n  sessionId: getSessionId(),\n});\n"})}),"\n",(0,i.jsx)(n.h3,{id:"with-input-restrictions",children:"With Input Restrictions"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// app/actions.ts\n'use server';\n\nimport { secureServerAction } from '@/lib/fortress';\n\nexport const updateSettings = secureServerAction(\n  async (settings: Settings) => {\n    await db.settings.update(settings);\n    return { success: true };\n  },\n  {\n    sanitizeInputs: true,\n    allowedInputs: ['theme', 'language', 'notifications'], // Only these keys\n  }\n);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"with-depth-limiting",children:"With Depth Limiting"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// app/actions.ts\n'use server';\n\nimport { secureServerAction } from '@/lib/fortress';\n\nexport const processComplexData = secureServerAction(\n  async (data: ComplexData) => {\n    const result = await processData(data);\n    return { success: true, result };\n  },\n  {\n    maxDepth: 5, // Limit nesting to 5 levels\n    sanitizeInputs: true,\n  }\n);\n"})}),"\n",(0,i.jsx)(n.h2,{id:"options-reference",children:"Options Reference"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"interface SecureActionOptions {\n  // Require CSRF token validation\n  requireCSRF?: boolean;\n  \n  // Sanitize inputs (remove dangerous keys)\n  sanitizeInputs?: boolean;\n  \n  // Maximum nesting depth\n  maxDepth?: number;\n  \n  // Allowed input keys (whitelist)\n  allowedInputs?: string[];\n  \n  // Rate limit key for this action\n  rateLimitKey?: string;\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"real-world-examples",children:"Real-World Examples"}),"\n",(0,i.jsx)(n.h3,{id:"form-submission",children:"Form Submission"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// app/actions.ts\n'use server';\n\nimport { secureServerAction } from '@/lib/fortress';\nimport { revalidatePath } from 'next/cache';\n\nexport const submitContactForm = secureServerAction(\n  async (formData: ContactForm) => {\n    // Validated: no injection, no prototype pollution\n    await db.contacts.create(formData);\n    await sendEmail(formData.email, 'Thank you');\n    \n    revalidatePath('/contact');\n    return { success: true };\n  },\n  {\n    sanitizeInputs: true, // Clean the input\n  }\n);\n\n// Component usage:\n// app/contact/page.tsx\n'use client';\n\nexport default function ContactPage() {\n  const handleSubmit = async (e: FormEvent) => {\n    e.preventDefault();\n    const formData = new FormData(e.target);\n    \n    const result = await submitContactForm({\n      name: formData.get('name'),\n      email: formData.get('email'),\n      message: formData.get('message'),\n    });\n    \n    if (result.success) {\n      alert('Form submitted!');\n    }\n  };\n  \n  return <form onSubmit={handleSubmit}>...</form>;\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"user-authentication",children:"User Authentication"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// app/actions.ts\n'use server';\n\nimport { secureServerAction } from '@/lib/fortress';\n\nexport const login = secureServerAction(\n  async (username: string, password: string) => {\n    // Validated: no SQL injection in username\n    const user = await authenticateUser(username, password);\n    \n    if (!user) {\n      throw new Error('Invalid credentials');\n    }\n    \n    await createSession(user.id);\n    return { success: true, user };\n  },\n  {\n    sanitizeInputs: true,\n  }\n);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"data-update",children:"Data Update"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// app/actions.ts\n'use server';\n\nimport { secureServerAction } from '@/lib/fortress';\n\nexport const updateUser = secureServerAction(\n  async (userId: string, updates: UserUpdates) => {\n    // Dangerous keys removed automatically\n    // No __proto__, constructor, prototype\n    \n    await db.users.update(userId, updates);\n    return { success: true };\n  },\n  {\n    sanitizeInputs: true,\n    allowedInputs: ['name', 'email', 'bio'], // Only these fields\n  }\n);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"file-upload-processing",children:"File Upload Processing"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// app/actions.ts\n'use server';\n\nimport { secureServerAction } from '@/lib/fortress';\n\nexport const processUpload = secureServerAction(\n  async (fileMetadata: FileMetadata) => {\n    // Metadata validated for injection\n    const result = await processFile(fileMetadata);\n    return { success: true, result };\n  },\n  {\n    sanitizeInputs: true,\n    maxDepth: 3, // Shallow metadata only\n  }\n);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"admin-operations",children:"Admin Operations"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// app/admin/actions.ts\n'use server';\n\nimport { secureServerAction } from '@/lib/fortress';\n\nexport const promoteUser = secureServerAction(\n  async (userId: string, role: string, metadata: ActionMetadata) => {\n    // CSRF validated\n    // Inputs sanitized\n    \n    await db.users.update(userId, { role });\n    return { success: true };\n  },\n  {\n    requireCSRF: true,\n    sanitizeInputs: true,\n  }\n);\n"})}),"\n",(0,i.jsx)(n.h2,{id:"input-sanitization",children:"Input Sanitization"}),"\n",(0,i.jsx)(n.p,{children:"The wrapper automatically removes dangerous keys:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'// Input:\n{\n  name: "John",\n  email: "john@example.com",\n  __proto__: { isAdmin: true },\n  constructor: { prototype: { hacked: true } }\n}\n\n// After sanitization:\n{\n  name: "John",\n  email: "john@example.com"\n}\n// __proto__ and constructor removed!\n'})}),"\n",(0,i.jsx)(n.h3,{id:"nested-sanitization",children:"Nested Sanitization"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'// Input:\n{\n  user: {\n    profile: {\n      name: "John",\n      __proto__: { admin: true }\n    }\n  }\n}\n\n// After sanitization:\n{\n  user: {\n    profile: {\n      name: "John"\n    }\n  }\n}\n// Dangerous keys removed at all levels\n'})}),"\n",(0,i.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,i.jsx)(n.h3,{id:"validation-error",children:"Validation Error"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Client code:\ntry {\n  await updateProfile(userId, {\n    __proto__: { isAdmin: true }\n  });\n} catch (error) {\n  if (error instanceof SecurityError) {\n    console.error('Security validation failed:', error.message);\n    // Error: \"Dangerous key detected: __proto__\"\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"injection-detected",children:"Injection Detected"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'try {\n  await createPost(\n    "Title",\n    "Content with <script>alert(1)<\/script>"\n  );\n} catch (error) {\n  // Error: "XSS injection detected: <script>"\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"csrf-validation-failed",children:"CSRF Validation Failed"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"try {\n  await deleteAccount(userId, {\n    _csrf: 'invalid-token'\n  });\n} catch (error) {\n  // Error: \"CSRF validation failed\"\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"client-side-usage",children:"Client-Side Usage"}),"\n",(0,i.jsx)(n.h3,{id:"with-form",children:"With Form"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// app/profile/page.tsx\n'use client';\n\nimport { updateProfile } from '@/app/actions';\n\nexport default function ProfilePage() {\n  const handleSubmit = async (formData: FormData) => {\n    try {\n      const result = await updateProfile(\n        userId,\n        {\n          name: formData.get('name'),\n          bio: formData.get('bio'),\n        }\n      );\n      \n      if (result.success) {\n        toast.success('Profile updated!');\n      }\n    } catch (error) {\n      if (error instanceof Error) {\n        toast.error(error.message);\n      }\n    }\n  };\n  \n  return <form action={handleSubmit}>...</form>;\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"with-state-management",children:"With State Management"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// app/posts/page.tsx\n'use client';\n\nimport { useState } from 'react';\nimport { createPost } from '@/app/actions';\n\nexport default function CreatePostPage() {\n  const [loading, setLoading] = useState(false);\n  \n  const handleCreate = async (title: string, content: string) => {\n    setLoading(true);\n    \n    try {\n      const result = await createPost(title, content);\n      \n      if (result.success) {\n        router.push('/posts');\n      }\n    } catch (error) {\n      console.error('Failed to create post:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n  \n  return <PostForm onSubmit={handleCreate} />;\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"secureServerAction wrapper provides:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Automatic argument validation"}),"\n",(0,i.jsx)(n.li,{children:"Input sanitization"}),"\n",(0,i.jsx)(n.li,{children:"CSRF protection"}),"\n",(0,i.jsx)(n.li,{children:"Injection detection"}),"\n",(0,i.jsx)(n.li,{children:"Prototype pollution prevention"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"How to use:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"export const action = secureServerAction(\n  async (data: Data) => {\n    // Your logic here\n  },\n  {\n    sanitizeInputs: true,\n    requireCSRF: false,\n  }\n);\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Related Documentation:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/nextjs-fortress/docs/wrappers/api-route",children:"API Routes Wrapper"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/nextjs-fortress/docs/modules/csrf/csrf-protection",children:"CSRF Protection"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}}}]);